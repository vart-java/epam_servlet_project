-- This script was generated by a beta version of the ERD tool in pgAdmin 4.
-- Please log an issue at https://redmine.postgresql.org/projects/pgadmin4/issues/new if you find any bugs, including reproduction steps.

BEGIN;

drop table if exists users cascade;

drop table if exists appointments cascade;

drop table if exists role cascade;

drop table if exists procedures cascade;


CREATE TABLE public.role
(
    name character varying(32) NOT NULL,
    PRIMARY KEY (name)
);

CREATE TABLE public.users
(
    login character varying(32) NOT NULL,
    password character varying(64) NOT NULL,
    role_name character varying(32) NOT NULL,
    rating integer,
    PRIMARY KEY (login)
);

CREATE TABLE public.procedures
(
    name character varying(64) NOT NULL,
    duration bigint NOT NULL,
    PRIMARY KEY (name)
);

CREATE TABLE public.appointments
(
    id bigserial NOT NULL,
    procedure_name character varying(64) NOT NULL,
    master_login character varying(32) NOT NULL,
    client_login character varying(32) NOT NULL,
    start_time timestamp without time zone NOT NULL,
    procedure_duration bigint,
    is_confirmed boolean,
    PRIMARY KEY (id)
);

ALTER TABLE public.appointments
    ADD FOREIGN KEY (procedure_name)
        REFERENCES public.procedures (name)
        NOT VALID;


ALTER TABLE public.appointments
    ADD FOREIGN KEY (master_login)
        REFERENCES public.users (login)
        NOT VALID;


ALTER TABLE public.appointments
    ADD FOREIGN KEY (client_login)
        REFERENCES public.users (login)
        NOT VALID;


ALTER TABLE public.users
    ADD FOREIGN KEY (role_name)
        REFERENCES public.role (name)
        NOT VALID;

CREATE OR REPLACE FUNCTION setting_duration_from_procedures()
    RETURNS trigger AS
$$
BEGIN
    UPDATE appointments
    SET procedure_duration = (SELECT duration FROM procedures WHERE name=NEW.procedure_name)
    WHERE id = NEW.id;
    RETURN NEW;
END;
$$
    LANGUAGE 'plpgsql';

CREATE TRIGGER duration_setter
    AFTER INSERT
    ON appointments
    FOR EACH ROW
EXECUTE PROCEDURE setting_duration_from_procedures();

END;